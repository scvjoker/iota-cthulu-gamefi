"use client";

import { useCurrentAccount, useSignAndExecuteTransaction, useIotaClient } from "@iota/dapp-kit";
import { Transaction } from "@iota/iota-sdk/transactions";
import { useState, useEffect, useRef } from "react";
import { toast } from "sonner";
import { PACKAGE_ID, MODULE_NAME, RANDOM_OBJECT_ID } from "@/utils/constants";
import { TEXTS, processLog, Lang } from "@/utils/localization";
import { CinematicText } from "@/components/shared/CinematicText";
import { HistorySection } from "@/components/game/HistorySection";
import { LeaderboardSection } from "@/components/game/LeaderboardSection";
import { SimulationView } from "@/components/game/SimulationView";
import { Button } from "@/components/ui/button";
import { FileText, Stamp } from "lucide-react";

import {
  Chart as ChartJS, RadialLinearScale, PointElement, LineElement, Filler, Tooltip, Legend, ArcElement, CategoryScale, LinearScale, BarElement
} from 'chart.js';
ChartJS.register(RadialLinearScale, PointElement, LineElement, Filler, Tooltip, Legend, ArcElement, CategoryScale, LinearScale, BarElement);

// --- AdventureOverlay (ä¿æŒä¸è®Š) ---
function AdventureOverlay({ logs, onClose, outcome, lang }: { logs: string[], onClose: (ended: boolean, outcome: string) => void, outcome: string, lang: Lang }) {
    const [displayLogs, setDisplayLogs] = useState<string[]>([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    const bottomRef = useRef<HTMLDivElement>(null);
    useEffect(() => { if (currentIndex < logs.length) { const timer = setTimeout(() => { setDisplayLogs(prev => [...prev, processLog(logs[currentIndex], lang)]); setCurrentIndex(prev => prev + 1); }, 800); return () => clearTimeout(timer); } }, [currentIndex, logs]);
    useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: "smooth" }); }, [displayLogs]);
    const isFinished = currentIndex >= logs.length;
    const isFinalEnding = outcome === "MADNESS" || outcome === "Escaped" || outcome === "Madness" || outcome === "Resigned";
    return (
        <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6 animate-in fade-in duration-300">
            <div className="max-w-2xl w-full h-[80vh] flex flex-col gap-4 border-x border-slate-800 bg-slate-950/50">
                <div className="p-4 border-b border-slate-800 bg-slate-900"><h2 className="text-xl font-mono text-green-500 flex items-center gap-2"><span className="animate-pulse">â—</span> TRPG LOG</h2></div>
                <div className="flex-1 overflow-y-auto p-6 font-mono text-base space-y-4 custom-scrollbar">
                    {displayLogs.map((log, idx) => (<div key={idx} className="border-l-2 border-slate-700 pl-4 py-2 animate-in slide-in-from-left-2 fade-in"><span className="text-slate-300">{log}</span></div>))}
                    <div ref={bottomRef} />
                </div>
                {isFinished && <div className="p-6 border-t border-slate-800 flex justify-center bg-slate-900"><Button onClick={() => onClose(isFinalEnding, outcome)} className="w-full max-w-sm bg-slate-100 text-black hover:bg-white font-bold text-lg h-12">{outcome === "Looping" ? "ğŸ”„ Continue" : "ğŸšª Close"}</Button></div>}
            </div>
        </div>
    );
}

// --- é›¢è·è­‰æ›¸çµ„ä»¶ (è®€å– SBT è³‡æ–™) ---
function ResignationCertificate({ data, onClose, t }: { data: any, onClose: () => void, t: any }) {
    if (!data) return null;

    // å…¼å®¹ï¼šå¦‚æœæ˜¯ SBT (final_depth) æˆ– NFT (loop_depth)
    const depth = data.final_depth !== undefined ? data.final_depth : data.loop_depth;
    const exp = data.career_exp !== undefined ? data.career_exp : data.exp;

    return (
        <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 animate-in fade-in duration-500 backdrop-blur-sm">
            <div className="bg-[#fdfbf7] text-slate-900 w-full max-w-md p-8 shadow-2xl relative transform rotate-1 animate-in zoom-in-95 duration-500 border border-slate-300">
                <div className="absolute inset-2 border-2 border-double border-slate-800 pointer-events-none"></div>
                <div className="text-center font-serif space-y-6 pt-4 relative z-10">
                    <div className="flex justify-center text-slate-800 mb-2"><FileText size={48} strokeWidth={1} /></div>
                    <h1 className="text-3xl font-bold border-b-2 border-slate-800 pb-4 inline-block px-8 tracking-widest">{t.cert_title}</h1>
                    <div className="text-lg leading-relaxed text-slate-700">
                        <p>{t.cert_content}</p>
                        <p className="text-2xl font-bold my-2 text-indigo-900 font-mono bg-slate-100 py-1">{data.name}</p>
                        <p>{t.cert_content2}</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4 text-sm border-t border-dashed border-slate-400 pt-4 mt-4">
                        <div className="text-right text-slate-500">{t.cert_stat_depth}:</div>
                        <div className="text-left font-bold font-mono text-xl">B{depth}F</div>
                        <div className="text-right text-slate-500">{t.cert_stat_mist}:</div>
                        <div className="text-left font-bold font-mono text-xl">{exp}</div>
                    </div>
                    <div className="flex justify-end mt-8 pt-4 relative">
                        <div className="absolute -top-6 right-8 transform rotate-[-15deg] opacity-90 animate-in zoom-in duration-300 delay-500">
                            <div className="border-4 border-red-700 text-red-700 px-4 py-2 font-black text-xl tracking-widest uppercase rounded-sm flex items-center gap-2 shadow-sm" style={{mixBlendMode: 'multiply'}}>
                                <Stamp size={24}/> {t.cert_stamp}
                            </div>
                            <div className="text-red-700/80 text-[10px] text-center mt-1 font-bold">{t.cert_dept}</div>
                        </div>
                    </div>
                </div>
                <div className="mt-12">
                    <Button onClick={onClose} className="w-full bg-slate-900 text-white hover:bg-slate-800 h-12 font-bold tracking-wide shadow-lg">{t.cert_close}</Button>
                </div>
            </div>
        </div>
    );
}

export function GameDashboard({ lang }: { lang: Lang }) {
  const account = useCurrentAccount();
  const client = useIotaClient();
  const { mutate: signAndExecuteTransaction } = useSignAndExecuteTransaction();

  const [loading, setLoading] = useState(false);
  const [investigators, setInvestigators] = useState<any[]>([]);
  const [memorials, setMemorials] = useState<any[]>([]); // ğŸ”¥ æ–°å¢ï¼šSBT åˆ—è¡¨
  const [selectedId, setSelectedId] = useState<string | null>(null);
  
  const [adventureData, setAdventureData] = useState<any>(null); 
  const [viewingCert, setViewingCert] = useState<any>(null); // ğŸ”¥ æ–°å¢ï¼šæ­£åœ¨æŸ¥çœ‹å“ªå¼µè­‰æ›¸
  
  const [showIntro, setShowIntro] = useState(true);
  const [outroType, setOutroType] = useState<any>("none");
  
  const STORAGE_KEY = `iota_trpg_history_${PACKAGE_ID}`; 
  const [history, setHistory] = useState<any[]>([]);

  useEffect(() => { 
      const saved = localStorage.getItem(STORAGE_KEY); 
      if (saved) try { setHistory(JSON.parse(saved)); } catch (e) {} 
  }, []);

  const currentInvestigator = investigators.find(i => i.id === selectedId);
  const t = TEXTS[lang]; 

  const addToHistory = (logs: string[], outcome: string) => { 
      if (!currentInvestigator) return;
      const newEntry = { 
          id: crypto.randomUUID(), 
          timestamp: Date.now(), 
          logs, 
          outcome,
          investigatorId: currentInvestigator.id, 
          investigatorName: currentInvestigator.name 
      }; 
      const newHistory = [newEntry, ...history]; 
      setHistory(newHistory); 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(newHistory)); 
  };

  // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šåŒæ™‚æŠ“å– Investigator å’Œ MemorialSBT
  const fetchData = async () => {
    if (!account) return;
    const objects = await client.getOwnedObjects({ owner: account.address, options: { showType: true, showContent: true } });
    
    const investType = `${PACKAGE_ID}::${MODULE_NAME}::Investigator`;
    const sbtType = `${PACKAGE_ID}::${MODULE_NAME}::MemorialSBT`;

    const activeList: any[] = [];
    const resignedList: any[] = [];

    objects.data.forEach((obj) => {
        if (obj.data?.content?.dataType === "moveObject") {
            const type = obj.data.type;
            const fields = { ...obj.data.content.fields, id: obj.data.objectId };
            
            if (type === investType) activeList.push(fields);
            else if (type === sbtType) resignedList.push(fields);
        }
    });

    setInvestigators(activeList);
    setMemorials(resignedList);

    // å¦‚æœæ²’æœ‰é¸ä¸­äººï¼Œä¸”æœ‰ç¾è·å“¡å·¥ï¼Œé è¨­é¸ç¬¬ä¸€å€‹
    if (!selectedId && activeList.length > 0) setSelectedId(activeList[0].id);
  };

  useEffect(() => { fetchData(); }, [account]);

  const executeScenarioTx = async (tx: Transaction) => { 
      setLoading(true); 
      tx.setGasBudget(100000000); 
      signAndExecuteTransaction({ transaction: tx, options: { showEffects: true, showEvents: true } }, { 
          onSuccess: async (result) => { 
              let events = result.events || []; 
              if (events.length === 0) { 
                  await new Promise(r => setTimeout(r, 2000)); 
                  try { const r = await client.getTransactionBlock({ digest: result.digest, options: { showEvents: true, showEffects: true } }); events = r.events || []; } catch (e) {} 
              } 
              const event = events.find(e => e.type.includes("ScenarioEvent")); 
              if (event) { 
                  setAdventureData({ logs: event.parsedJson?.logs, outcome: event.parsedJson?.outcome }); 
                  addToHistory(event.parsedJson?.logs, event.parsedJson?.outcome); 
              } 
              setLoading(false); 
          }, 
          onError: (e) => { toast.error(e.message); setLoading(false); } 
      }); 
  };
  
  const mint = () => { const tx = new Transaction(); tx.moveCall({ target: `${PACKAGE_ID}::${MODULE_NAME}::mint`, arguments: [ tx.object(RANDOM_OBJECT_ID), tx.pure.vector("u8", Array.from(new TextEncoder().encode("Staff #" + Math.floor(Math.random()*9000+1000)))) ] }); tx.setGasBudget(50000000); signAndExecuteTransaction({ transaction: tx, options: { showEffects: true, showEvents: true } }, { onSuccess: () => { setLoading(false); setTimeout(fetchData, 1000); setShowIntro(true); }, onError: (err) => { toast.error(err.message); setLoading(false); } }); };
  
  // é›¢è·é‚è¼¯
  const resign = () => {
      if (!currentInvestigator) return;
      const tx = new Transaction();
      tx.moveCall({ target: `${PACKAGE_ID}::${MODULE_NAME}::resign`, arguments: [tx.object(currentInvestigator.id)] });
      tx.setGasBudget(50000000);
      signAndExecuteTransaction({ transaction: tx, options: { showEffects: true, showEvents: true } }, {
          onSuccess: (result) => { 
              setLoading(false); 
              toast.success(lang === 'zh' ? "é›¢è·æ‰‹çºŒå·²å®Œæˆ (NFT éŠ·æ¯€)" : "Resignation Accepted (NFT Burned)");
              
              const logs = ["=== HR Department ===", "Resignation letter received.", "NFT Access Card destroyed.", "You are free."];
              addToHistory(logs, "Resigned"); 
              
              // äº¤æ˜“æˆåŠŸå¾Œï¼Œé‡æ–°æŠ“å–åˆ—è¡¨ (æ–°çš„ SBT å°±æœƒå‡ºç¾)
              setTimeout(() => { 
                  fetchData(); 
                  setSelectedId(null); 
              }, 1000);
          },
          onError: (err) => { toast.error(err.message); setLoading(false); }
      });
  };

  const singleSanityCheck = () => { if(!currentInvestigator) return; const tx = new Transaction(); tx.moveCall({target:`${PACKAGE_ID}::${MODULE_NAME}::sanity_check`, arguments:[tx.object(currentInvestigator.id), tx.object(RANDOM_OBJECT_ID)]}); executeScenarioTx(tx); };
  const batchSanityCheck = () => { if(!currentInvestigator) return; const tx = new Transaction(); tx.moveCall({target:`${PACKAGE_ID}::${MODULE_NAME}::batch_sanity_check`, arguments:[tx.object(currentInvestigator.id), tx.object(RANDOM_OBJECT_ID)]}); executeScenarioTx(tx); };
  const playQuick = () => { if(!currentInvestigator)return; const tx = new Transaction(); tx.moveCall({target:`${PACKAGE_ID}::${MODULE_NAME}::play_stairs_quick`,arguments:[tx.object(currentInvestigator.id),tx.object(RANDOM_OBJECT_ID)]}); executeScenarioTx(tx); };
  const playManualStart = () => { if(!currentInvestigator)return; const tx = new Transaction(); tx.moveCall({target:`${PACKAGE_ID}::${MODULE_NAME}::manual_start`,arguments:[tx.object(currentInvestigator.id),tx.object(RANDOM_OBJECT_ID)]}); executeScenarioTx(tx); };
  const playManualAction = (c:number) => { if(!currentInvestigator)return; const tx = new Transaction(); tx.moveCall({target:`${PACKAGE_ID}::${MODULE_NAME}::manual_resolve`,arguments:[tx.object(currentInvestigator.id),tx.object(RANDOM_OBJECT_ID),tx.pure.u8(c)]}); executeScenarioTx(tx); };
  const getImageUrl = (inv: any) => inv?.is_mad ? "/images/madness.png" : "/images/investigator.png";

  return (
      <>
          {showIntro && <CinematicText lines={t.intro_lines} onComplete={() => setShowIntro(false)} />}
          {outroType !== "none" && <CinematicText lines={outroType==="madness"?t.outro_madness:t.outro_escaped} onComplete={() => setOutroType("none")} isMadness={outroType==="madness"} />}
          
          {adventureData && <AdventureOverlay logs={adventureData.logs} outcome={adventureData.outcome} lang={lang} onClose={(ended: boolean, outcome: string) => { setAdventureData(null); fetchData(); if (ended) setOutroType(outcome.toLowerCase().includes("mad")?"madness":"escaped"); }} />}
          
          {/* ğŸ”¥ é›¢è·è­‰æ›¸ (é»æ“Šåˆ—è¡¨ SBT æ™‚è§¸ç™¼) */}
          {viewingCert && <ResignationCertificate data={viewingCert} t={t} onClose={() => setViewingCert(null)} />}

          <div className="max-w-6xl mx-auto mt-8 px-4 pb-20 animate-in fade-in zoom-in-95 duration-500">
              <div className="text-center mb-8"><h1 className="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-indigo-600 font-serif tracking-widest uppercase mb-2">{t.title}</h1><p className="text-slate-500 text-sm tracking-widest">{t.subtitle}</p></div>
              <SimulationView 
                  account={account} 
                  investigators={investigators} 
                  memorials={memorials} // ğŸ”¥ å‚³å…¥ SBT åˆ—è¡¨
                  currentInvestigator={currentInvestigator} 
                  loading={loading} 
                  t={t}
                  mint={mint} 
                  singleSanityCheck={singleSanityCheck} 
                  batchSanityCheck={batchSanityCheck} 
                  playQuick={playQuick} playManualStart={playManualStart} playManualAction={playManualAction}
                  resign={resign} 
                  setSelectedId={setSelectedId} 
                  onViewCert={setViewingCert} // ğŸ”¥ ç¶å®šæŸ¥çœ‹è­‰æ›¸äº‹ä»¶
                  getImageUrl={getImageUrl} 
                  lang={lang}
              />
              <div className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                  <HistorySection history={history} lang={lang} />
                  <LeaderboardSection client={client} lang={lang} />
              </div>
          </div>
      </>
  );
}